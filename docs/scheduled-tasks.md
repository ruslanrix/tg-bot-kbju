# Запланированные задачи

## Обзор

Бот не содержит встроенного планировщика. Вместо этого предоставляются два POST-эндпоинта, которые вызываются внешним HTTP-cron сервисом (рекомендуется [cron-job.org](https://cron-job.org)):

| Эндпоинт | Назначение |
|----------|-----------|
| `POST /tasks/remind` | Отправка напоминаний неактивным пользователям |
| `POST /tasks/purge` | Физическое удаление старых мягко-удалённых приёмов пищи |

Оба эндпоинта защищены заголовком `X-Tasks-Secret`.

---

## POST /tasks/remind — Напоминания

### Логика работы

1. Вычисляются две временные отсечки:
   - `inactivity_cutoff` = текущее время - `REMINDER_INACTIVITY_HOURS` (по умолчанию 6 часов)
   - `cooldown_cutoff` = текущее время - `REMINDER_COOLDOWN_HOURS` (по умолчанию 6 часов)

2. Атомарный SQL-запрос `UPDATE ... SET last_reminder_at = now() RETURNING ...` (метод `UserRepo.claim_inactive_users`) находит и одновременно «захватывает» пользователей, соответствующих критериям:
   - У пользователя установлен часовой пояс (`tz_mode` задан — прошёл онбординг)
   - `last_activity_at` < `inactivity_cutoff` (неактивен дольше порога)
   - `last_reminder_at` равен `NULL` **или** `last_reminder_at` < `cooldown_cutoff` (не получал напоминание в окне кулдауна)

3. Атомарный UPDATE гарантирует, что при параллельных вызовах каждый пользователь будет обработан только один раз.

4. После коммита транзакции отправляются сообщения через Telegram Bot API. Текст напоминания локализован: `t("reminder_text", user.language)`.

5. Если отправка конкретному пользователю не удалась (например, пользователь заблокировал бота), счётчик `failed` увеличивается, но `last_reminder_at` уже сохранён — повторный вызов не отправит дубликат.

### Параметры конфигурации

| Переменная | По умолчанию | Описание |
|------------|-------------|----------|
| `REMINDER_INACTIVITY_HOURS` | `6` | Через сколько часов неактивности считать пользователя «неактивным» |
| `REMINDER_COOLDOWN_HOURS` | `6` | Минимальный интервал между напоминаниями одному пользователю |

### Ответ

```json
{"status": "ok", "sent": 3, "failed": 1}
```

---

## POST /tasks/purge — Очистка

### Логика работы

1. Вычисляется отсечка: текущее время - `PURGE_DELETED_AFTER_DAYS` дней (по умолчанию 30).
2. Метод `MealRepo.hard_delete_deleted_before(session, cutoff)` физически удаляет из БД все записи приёмов пищи, которые были мягко-удалены (`deleted_at IS NOT NULL`) раньше отсечки.
3. Транзакция коммитится.

### Параметры конфигурации

| Переменная | По умолчанию | Описание |
|------------|-------------|----------|
| `PURGE_DELETED_AFTER_DAYS` | `30` | Через сколько дней после мягкого удаления физически удалять запись |

### Ответ

```json
{"status": "ok", "deleted_count": 5}
```

---

## Аутентификация

Оба эндпоинта требуют заголовок `X-Tasks-Secret`, значение которого должно совпадать с переменной окружения `TASKS_SECRET`.

**Правила:**
- Если `TASKS_SECRET` не задан (пустая строка) — эндпоинты возвращают `403` на все запросы (отключены).
- Если `X-Tasks-Secret` не передан в запросе — `403`.
- Если значения не совпадают — `403`.
- `TASKS_SECRET` должен быть не менее 8 символов.

Рекомендация — генерировать случайную строку:

```bash
openssl rand -hex 16
```

---

## Пошаговая настройка cron-job.org

### 1. Создать аккаунт

Зарегистрируйтесь на [https://cron-job.org](https://cron-job.org). Бесплатный план позволяет создать достаточное количество задач.

### 2. Задача «Reminders» (напоминания)

1. Нажмите **Create Cronjob**.

2. Заполните поля:
   - **Title:** `KBJU Bot — Reminders`
   - **URL:** `https://<ваш-домен>.up.railway.app/tasks/remind`

3. **ВАЖНО:** Перейдите во вкладку **ADVANCED** и в поле **Request Method** выберите **POST**.
   > По умолчанию cron-job.org использует метод GET. Если оставить GET, эндпоинт вернёт **405 Method Not Allowed**, потому что `/tasks/remind` принимает только POST-запросы.

4. **Schedule (расписание):** выберите «Every 1 hour» или задайте cron-выражение:
   ```
   0 */1 * * *
   ```

5. Перейдите во вкладку **Headers** и добавьте заголовок:
   - **Key:** `X-Tasks-Secret`
   - **Value:** `<значение вашего TASKS_SECRET>`

6. Нажмите **Save** (Сохранить).

### 3. Задача «Purge» (очистка)

1. Нажмите **Create Cronjob**.

2. Заполните поля:
   - **Title:** `KBJU Bot — Purge`
   - **URL:** `https://<ваш-домен>.up.railway.app/tasks/purge`

3. **ADVANCED** → **Request Method** → **POST**.

4. **Schedule:** ежедневно в 03:00 UTC:
   ```
   0 3 * * *
   ```

5. **Headers:**
   - **Key:** `X-Tasks-Secret`
   - **Value:** `<значение вашего TASKS_SECRET>`

6. Нажмите **Save**.

### 4. Проверка

После создания задачи выполните ручной запуск (кнопка **Run now** или **Test run**):
- Ожидаемый HTTP-код: `200`
- Ожидаемое тело ответа: JSON с полем `"status": "ok"`

---

## Рекомендуемые расписания

| Задача | Cron-выражение | Частота | Обоснование |
|--------|---------------|---------|-------------|
| `remind` | `0 */1 * * *` | Каждый час | При 6-часовом окне неактивности ежечасная проверка обеспечивает своевременную отправку без излишней нагрузки |
| `purge` | `0 3 * * *` | Раз в день, 03:00 UTC | Минимальная нагрузка на БД в непиковое время. Один раз в сутки достаточно для retention-политики |

---

## Устранение неполадок

### 405 Method Not Allowed

**Причина:** Метод запроса — GET вместо POST.

**Решение:** В cron-job.org откройте задачу, перейдите во вкладку **ADVANCED** и переключите **Request Method** на **POST**.

### 403 Forbidden

**Причина:** Значение `X-Tasks-Secret` не совпадает с `TASKS_SECRET`, заголовок отсутствует, или `TASKS_SECRET` не задан в переменных окружения.

**Решение:**
1. Убедитесь, что переменная `TASKS_SECRET` задана в окружении приложения (Railway, `.env`).
2. Убедитесь, что заголовок `X-Tasks-Secret` в cron-job.org содержит точно такое же значение.
3. Убедитесь, что `TASKS_SECRET` содержит не менее 8 символов.

### 503 Service Unavailable

**Причина:** Приложение не запущено или не завершило инициализацию.

**Решение:** Проверьте состояние деплоя в Railway. Убедитесь, что приложение успешно запустилось (healthcheck `/health` возвращает `200`).

### 0 sent (напоминания не отправляются)

**Причина:** Нет пользователей, подходящих под критерии отправки напоминания.

**Решение:**
1. Убедитесь, что `REMINDER_INACTIVITY_HOURS` соответствует ожиданиям (по умолчанию 6 часов).
2. Проверьте, что у пользователей установлен часовой пояс (прошли онбординг).
3. Проверьте, что пользователи действительно неактивны дольше заданного порога.

### Timeout (превышение времени ожидания)

**Причина:** Большое количество пользователей или медленная сеть.

**Решение:** В cron-job.org во вкладке **ADVANCED** увеличьте значение **Request timeout** (например, до 30 секунд).

---

## Безопасность

- `TASKS_SECRET` должен быть случайной строкой длиной не менее 8 символов.
- Рекомендуемый способ генерации:

```bash
openssl rand -hex 16
```

- Не передавайте секрет в URL-параметрах — используйте только заголовок `X-Tasks-Secret`.
- Храните `TASKS_SECRET` в защищённых переменных окружения (Railway Variables, `.env`).

---

## Примеры запросов через curl

### Напоминания

```bash
curl -X POST https://<домен>/tasks/remind \
  -H "X-Tasks-Secret: <секрет>"
```

Ожидаемый ответ:

```json
{"status": "ok", "sent": 2, "failed": 0}
```

### Очистка

```bash
curl -X POST https://<домен>/tasks/purge \
  -H "X-Tasks-Secret: <секрет>"
```

Ожидаемый ответ:

```json
{"status": "ok", "deleted_count": 7}
```
