# Интернационализация (i18n)

Исходные файлы:
- `app/i18n/__init__.py` — модуль с функцией `t()` и реестром локалей
- `app/i18n/locales/en.py` — английские строки
- `app/i18n/locales/ru.py` — русские строки
- `app/services/nutrition_ai.py` — языковые инструкции для OpenAI

## Обзор

Бот поддерживает два языка:
- **EN** — English (язык по умолчанию и fallback)
- **RU** — Русский

Язык хранится в поле `language` таблицы `users` и выбирается пользователем в настройках.

---

## Архитектура

### Реестр локалей

Файл `app/i18n/__init__.py` содержит словарь `_LOCALES`, связывающий код языка с его словарём строк:

```python
_LOCALES: dict[str, dict[str, str]] = {
    "EN": EN_STRINGS,  # из locales/en.py
    "RU": RU_STRINGS,  # из locales/ru.py
}
```

Язык по умолчанию определён константой `DEFAULT_LANG = "EN"`.

### Словари строк

Каждый файл локали (`locales/en.py`, `locales/ru.py`) экспортирует словарь `STRINGS: dict[str, str]`, где ключ — идентификатор строки, значение — переведённый текст.

Ключи в `ru.py` должны зеркалировать ключи в `en.py`. Отсутствующие ключи автоматически подставляются из английской локали.

---

## Функция t(key, lang)

Основная функция перевода:

```python
from app.i18n import t

text = t("welcome_back", "RU")  # -> "С возвращением! ..."
text = t("welcome_back", "EN")  # -> "Welcome back! ..."
text = t("welcome_back", "FR")  # -> EN fallback
text = t("nonexistent_key", "EN")  # -> "nonexistent_key"
```

### Алгоритм поиска

1. Приведение кода языка к верхнему регистру (`lang.upper()`).
2. Поиск в словаре запрошенного языка (`_LOCALES[code]`).
3. Если не найдено — fallback на английский (`EN_STRINGS`).
4. Если ключ не найден ни в одной локали — возвращается сам ключ.

Функция **никогда не выбрасывает исключений** — это безопасно для использования в любом контексте. Незнакомые ключи легко заметить в интерфейсе бота.

---

## Области применения

Система переводов используется в следующих областях:

| Область | Описание |
|---------|----------|
| Сообщения бота | Ответы на команды, обработка приёмов пищи, ошибки |
| Клавиатуры | Тексты кнопок (reply и inline) |
| Форматтеры | Заголовки статистики, названия нутриентов, единицы измерения |
| Напоминания | Текст напоминаний для неактивных пользователей |
| OpenAI | Языковые инструкции для системного промпта |

---

## Интеграция с OpenAI

Файл `app/services/nutrition_ai.py` содержит словарь `_LANG_INSTRUCTIONS`, определяющий 13-е правило системного промпта для каждого языка:

```python
_LANG_INSTRUCTIONS: dict[str, str] = {
    "EN": "13. Respond in English. All text fields ... must be in English.",
    "RU": "13. Отвечай на русском языке. Все текстовые поля ... должны быть на русском.",
}
```

Функция `_build_system_prompt(lang)` добавляет соответствующую инструкцию к базовому промпту. Неизвестные языки используют английскую инструкцию.

Благодаря этому `meal_name`, `user_message` и названия ингредиентов возвращаются на языке пользователя.

---

## Как добавить новый ключ

1. **Добавьте ключ в `locales/en.py`:**

```python
STRINGS: dict[str, str] = {
    # ... существующие ключи ...
    "my_new_key": "My new message",
}
```

2. **Добавьте перевод в `locales/ru.py`:**

```python
STRINGS: dict[str, str] = {
    # ... существующие ключи ...
    "my_new_key": "Моё новое сообщение",
}
```

3. **Используйте в коде:**

```python
from app.i18n import t

text = t("my_new_key", user.language)
```

---

## Как добавить новый язык

Для добавления, например, испанского (ES):

### 1. Создайте файл локали

Создайте `app/i18n/locales/es.py` со словарём `STRINGS`, содержащим переводы всех ключей из `en.py`:

```python
STRINGS: dict[str, str] = {
    "welcome_back": "Bienvenido de nuevo! ...",
    # ... все остальные ключи ...
}
```

### 2. Зарегистрируйте в `__init__.py`

```python
from app.i18n.locales.es import STRINGS as ES_STRINGS

_LOCALES: dict[str, dict[str, str]] = {
    "EN": EN_STRINGS,
    "RU": RU_STRINGS,
    "ES": ES_STRINGS,  # новый язык
}
```

### 3. Добавьте инструкцию для OpenAI

В `app/services/nutrition_ai.py` добавьте запись в `_LANG_INSTRUCTIONS`:

```python
_LANG_INSTRUCTIONS: dict[str, str] = {
    "EN": "13. Respond in English. ...",
    "RU": "13. Отвечай на русском языке. ...",
    "ES": "13. Responde en español. Todos los campos de texto ... deben estar en español.",
}
```

### 4. Обновите клавиатуру выбора языка

В обработчике выбора языка (`language_keyboard()`) добавьте кнопку для нового языка.

### 5. Обновите `all_main_button_texts()`

Добавьте тексты кнопок нового языка в множество всех кнопок главной клавиатуры, чтобы фильтрация работала корректно.

### 6. Добавьте тесты

Напишите тесты, проверяющие:
- Наличие всех ключей из `en.py` в новом файле локали.
- Корректную работу `t()` с новым кодом языка.
- Корректную генерацию системного промпта для нового языка.

---

## Категории ключей

Ключи группируются по функциональным областям с помощью префиксов:

| Префикс | Область | Примеры |
|---------|---------|---------|
| `onboarding_*` | Онбординг нового пользователя | `onboarding_a`, `onboarding_b`, `onboarding_tz_alert` |
| `welcome_*` | Команда /start | `welcome_back` |
| `help_*` | Команда /help | `help_text` |
| `msg_*` | Обработка приёмов пищи | `msg_unrecognized`, `msg_throttle`, `msg_sanity_fail`, `msg_processing_new` |
| `fmt_*` | Форматтеры (нутриенты, статистика) | `fmt_calories`, `fmt_protein`, `fmt_today_stats_header` |
| `kb_*` | Кнопки клавиатур | `kb_stats`, `kb_save`, `kb_edit`, `kb_today` |
| `goal_*` | Цели питания | `goal_maintenance`, `goal_deficit`, `goal_bulk` |
| `goals_*` | UI целей | `goals_prompt` |
| `tz_*` | Часовой пояс | `tz_choose_city`, `tz_choose_offset`, `tz_saved` |
| `edit_feedback_*` | UX редактирования | `edit_feedback_prompt`, `edit_feedback_updated`, `edit_feedback_timeout` |
| `reminder_*` | Напоминания | `reminder_text` |
| `lang_*` | Выбор языка | `lang_unknown`, `lang_set_confirmation` |
| `stub_*` | Заглушки | `stub_feedback`, `stub_subscription` |
| `precheck_*` | Предварительные проверки | `precheck_not_text_or_photo`, `precheck_water`, `precheck_vague` |
| `nav_*` | Навигация | `nav_arrow` |
| (без префикса) | Разное | `meal_not_found`, `already_saved`, `deleted_label`, `draft_expired`, `add_prompt`, `stats_choose_period` |
