# Конфигурация

Исходный файл: `app/core/config.py`

## Обзор

Конфигурация приложения построена на **Pydantic Settings** (`pydantic_settings.BaseSettings`). Все настройки считываются из переменных окружения и (опционально) из файла `.env` в корне проекта.

Доступ к настройкам осуществляется через фабрику-синглтон:

```python
from app.core.config import get_settings

settings = get_settings()  # кэшируется через @lru_cache(maxsize=1)
```

При первом вызове `get_settings()` Pydantic валидирует все значения. Если какое-либо обязательное поле не задано или валидация не проходит, приложение не запустится и выбросит ошибку с описанием проблемы.

---

## Обязательные переменные

Эти переменные **должны быть заданы** — без них приложение не запустится.

| Переменная | Тип | Описание |
|------------|-----|----------|
| `BOT_TOKEN` | `str` | Токен Telegram-бота, полученный у [@BotFather](https://t.me/BotFather) |
| `DATABASE_URL` | `str` | Строка подключения к PostgreSQL в формате `postgresql+asyncpg://user:pass@host:port/dbname` |
| `OPENAI_API_KEY` | `str` | API-ключ OpenAI для анализа питания |

---

## Webhook (опционально)

Переменные для работы в режиме webhook (продакшен). Если `PUBLIC_URL` не задан — бот работает в режиме polling (для локальной разработки).

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|-------------|----------|
| `PUBLIC_URL` | `str` | `""` | Публичный HTTPS-адрес приложения. Должен начинаться с `https://`, не должен заканчиваться на `/` |
| `WEBHOOK_SECRET` | `str` | `""` | Секрет для валидации webhook-запросов. Минимум 8 символов, если задан. **Обязателен**, когда задан `PUBLIC_URL` |

---

## Запланированные задачи

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|-------------|----------|
| `TASKS_SECRET` | `str` | `""` | Секрет для аутентификации запросов к эндпоинтам `/tasks/*`. Минимум 8 символов, если задан. Пустая строка — эндпоинты отключены (вернут 403) |

---

## Администрирование

| Переменная | Тип | По умолчанию | Описание |
|------------|-----|-------------|----------|
| `ADMIN_IDS` | `str` | `""` | Список Telegram user ID администраторов через запятую (например, `123456,789012`) |

---

## Опциональные переменные с дефолтами

| Переменная | Тип | По умолчанию | Ограничение | Описание |
|------------|-----|-------------|-------------|----------|
| `OPENAI_MODEL` | `str` | `gpt-4o-mini` | — | Модель OpenAI для анализа питания |
| `OPENAI_TIMEOUT_SECONDS` | `int` | `30` | > 0 | Таймаут запросов к OpenAI (секунды) |
| `LOG_LEVEL` | `str` | `INFO` | — | Уровень логирования (`DEBUG`, `INFO`, `WARNING`, `ERROR`) |
| `MAX_PHOTO_BYTES` | `int` | `5242880` (5 МБ) | > 0 | Максимальный размер фото в байтах |
| `RATE_LIMIT_PER_MINUTE` | `int` | `6` | > 0 | Лимит запросов на анализ от одного пользователя в минуту |
| `MAX_CONCURRENT_PER_USER` | `int` | `1` | >= 1 | Максимум одновременных запросов на анализ от одного пользователя |
| `PORT` | `int` | `8000` | > 0 | Порт HTTP-сервера FastAPI |
| `EDIT_WINDOW_HOURS` | `int` | `48` | > 0 | Окно для редактирования приёма пищи (часы) |
| `DELETE_WINDOW_HOURS` | `int` | `48` | > 0 | Окно для удаления приёма пищи (часы) |
| `PURGE_DELETED_AFTER_DAYS` | `int` | `30` | > 0 | Через сколько дней физически удалять мягко-удалённые записи |
| `REMINDER_INACTIVITY_HOURS` | `int` | `6` | > 0 | Порог неактивности пользователя для отправки напоминания (часы) |
| `REMINDER_COOLDOWN_HOURS` | `int` | `6` | > 0 | Минимальный интервал между напоминаниями одному пользователю (часы) |

---

## Правила валидации

Pydantic выполняет следующие проверки при создании объекта `Settings`:

1. **Положительные числа** — поля `OPENAI_TIMEOUT_SECONDS`, `MAX_PHOTO_BYTES`, `RATE_LIMIT_PER_MINUTE`, `PORT`, `EDIT_WINDOW_HOURS`, `DELETE_WINDOW_HOURS`, `PURGE_DELETED_AFTER_DAYS`, `REMINDER_INACTIVITY_HOURS`, `REMINDER_COOLDOWN_HOURS` должны быть строго больше нуля.

2. **Конкурентность** — `MAX_CONCURRENT_PER_USER` должен быть >= 1.

3. **PUBLIC_URL** — если задан, должен начинаться с `https://` и не заканчиваться на `/`.

4. **WEBHOOK_SECRET** — если задан, минимум 8 символов. **Обязателен при заданном PUBLIC_URL** (проверяется через `model_validator`).

5. **TASKS_SECRET** — если задан, минимум 8 символов. Пустая строка отключает эндпоинты задач.

6. **ADMIN_IDS** — если задан, должен быть списком целых чисел через запятую (например, `123456,789012`). Невалидные значения приведут к ошибке запуска.

---

## Вычисляемые свойства

| Свойство | Тип | Описание |
|----------|-----|----------|
| `use_webhook` | `bool` | `True`, если `PUBLIC_URL` не пуст (режим webhook). `False` — режим polling |
| `admin_ids_list` | `list[int]` | Разобранный список `ADMIN_IDS` в виде списка целых чисел. Пустой список, если `ADMIN_IDS` не задан |

---

## Пример файла `.env`

```env
# Обязательные
BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrSTUvwxYZ
DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/kbju_bot
OPENAI_API_KEY=sk-...

# Webhook (продакшен)
PUBLIC_URL=https://my-bot.up.railway.app
WEBHOOK_SECRET=my-super-secret-string

# Задачи
TASKS_SECRET=another-secret-at-least-8

# Опциональные
OPENAI_MODEL=gpt-4o-mini
LOG_LEVEL=INFO
PORT=8000

# Администраторы
ADMIN_IDS=123456789,987654321
```
