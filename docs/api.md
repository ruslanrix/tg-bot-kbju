# API-эндпоинты

Исходный файл: `app/web/main.py`

## Обзор

HTTP-сервер построен на **FastAPI** (`app.web.main:app`). Автоматическая документация Swagger/ReDoc отключена (`docs_url=None`, `redoc_url=None`).

Приложение поддерживает два режима работы:
- **Webhook** (продакшен): `PUBLIC_URL` задан — Telegram отправляет апдейты на `POST /webhook/{secret}`.
- **Polling** (локальная разработка): `PUBLIC_URL` не задан — aiogram опрашивает Telegram API в фоновом режиме.

При запуске автоматически выполняются миграции базы данных через `alembic upgrade head`.

---

## GET /health

Проверка работоспособности (liveness check).

| Параметр | Значение |
|----------|----------|
| Метод | `GET` |
| Путь | `/health` |
| Аутентификация | Нет |
| Назначение | Healthcheck для Railway и мониторинга |

**Ответ:**

```json
{"status": "ok"}
```

**HTTP-коды:** `200 OK`

---

## POST /webhook/{secret}

Приём обновлений от Telegram API (webhook-режим).

| Параметр | Значение |
|----------|----------|
| Метод | `POST` |
| Путь | `/webhook/{secret}` |
| Аутентификация | Path-параметр `secret` должен совпадать с `WEBHOOK_SECRET` |
| Тело запроса | JSON-объект Telegram Update |

**HTTP-коды:**

| Код | Описание |
|-----|----------|
| `200` | Апдейт успешно обработан |
| `403` | Секрет не совпадает с `WEBHOOK_SECRET` |
| `503` | Бот или диспетчер не инициализированы |

---

## POST /tasks/purge

Физическое удаление мягко-удалённых приёмов пищи, у которых с момента удаления прошло больше `PURGE_DELETED_AFTER_DAYS` дней.

| Параметр | Значение |
|----------|----------|
| Метод | `POST` |
| Путь | `/tasks/purge` |
| Аутентификация | Заголовок `X-Tasks-Secret` должен совпадать с `TASKS_SECRET` |

**Ответ:**

```json
{"status": "ok", "deleted_count": 5}
```

- `deleted_count` — количество физически удалённых записей.

**HTTP-коды:**

| Код | Описание |
|-----|----------|
| `200` | Очистка выполнена |
| `403` | `X-Tasks-Secret` не совпадает, отсутствует или `TASKS_SECRET` не настроен |
| `503` | Фабрика сессий БД не инициализирована |

---

## POST /tasks/remind

Отправка напоминаний неактивным пользователям.

Находит пользователей, у которых:
- установлен часовой пояс (`tz_mode` задан);
- последняя активность (`last_activity_at`) раньше, чем `REMINDER_INACTIVITY_HOURS` назад;
- последнее напоминание (`last_reminder_at`) не отправлялось или отправлялось более `REMINDER_COOLDOWN_HOURS` назад.

Использует атомарный запрос `UPDATE ... SET last_reminder_at = now() RETURNING ...` (`claim_inactive_users`) для предотвращения дублирования при параллельных вызовах.

| Параметр | Значение |
|----------|----------|
| Метод | `POST` |
| Путь | `/tasks/remind` |
| Аутентификация | Заголовок `X-Tasks-Secret` должен совпадать с `TASKS_SECRET` |

**Ответ:**

```json
{"status": "ok", "sent": 3, "failed": 1}
```

- `sent` — количество успешно отправленных напоминаний.
- `failed` — количество неудачных отправок (например, пользователь заблокировал бота).

**HTTP-коды:**

| Код | Описание |
|-----|----------|
| `200` | Задача выполнена (даже если `sent=0`) |
| `403` | `X-Tasks-Secret` не совпадает, отсутствует или `TASKS_SECRET` не настроен |
| `503` | Фабрика сессий БД или бот не инициализированы |

---

## Примечания

- Эндпоинты `/tasks/*` используют отдельный движок БД (`_task_engine`), созданный при старте приложения. Это позволяет выполнять задачи изолированно от основного пула соединений бота.
- Отправка напоминаний происходит **за пределами** DB-сессии — если отправка конкретному пользователю не удалась, `last_reminder_at` уже сохранён, что защищает от спама при повторном вызове.
